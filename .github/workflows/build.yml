name: Build ShareX

on:
  push:
    branches:
      - "**"
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
    paths-ignore:
      - "**/*.md"
      - "**/*.gitignore"
      - "**/*.gitattributes"

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: Windows-2022

    strategy:
      fail-fast: false
      matrix:
        configuration: [Release, Debug, Steam, MicrosoftStore, MicrosoftStoreDebug]
        rid: [win-x64, win-arm64]

    env:
      SOLUTION_FILE_PATH: ShareX.sln
      APP_PROJ_PATH: ShareX/ShareX.csproj
      SETUP_PROJ_PATH: ShareX.Setup/ShareX.Setup.csproj
      ASSEMBLY_INFO_PATH: Directory.build.props

    outputs:
      APP_VERSION: ${{ env.APP_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Set APP_VERSION
        shell: pwsh
        run: |
          $content = Get-Content "${{ env.ASSEMBLY_INFO_PATH }}" -Raw
          $pattern = '<Version>([0-9]+(?:\.[0-9]+){1,3})</Version>'
          $m = [regex]::Match($content, $pattern)
          $v = $m.Groups[1].Value
          if ($env:GITHUB_REF -eq "refs/heads/develop") {
            $v = "$v.$env:GITHUB_RUN_NUMBER"
            $content = [regex]::Replace($content, $pattern, "<Version>$v</Version>")
            Set-Content -Path "${{ env.ASSEMBLY_INFO_PATH }}" -Value $content -NoNewline
          }
          echo "APP_VERSION=$v" >> $env:GITHUB_ENV

      - name: Download API keys
        if: ${{ secrets.API_KEYS != '' }}
        shell: pwsh
        run: Invoke-WebRequest -Uri "${{ secrets.API_KEYS }}" -OutFile "ShareX.UploadersLib\APIKeys\APIKeysLocal.cs"

      # Restore once per target RID for native deps
      - name: Restore for target RID
        run: dotnet restore --runtime "${{ matrix.rid }}" "${{ env.SOLUTION_FILE_PATH }}"

      # Build libs and common projects (no RID to avoid NETSDK1134)
      - name: Build solution (no RID)
        run: dotnet build --no-restore --configuration "${{ matrix.configuration }}" /m:1 "${{ env.SOLUTION_FILE_PATH }}"

      # Build ShareX.exe for win-x64 because Setup may read version from the x64 output path
      - name: Build ShareX.exe win-x64
        run: dotnet build "${{ env.APP_PROJ_PATH }}" --no-restore --configuration "${{ matrix.configuration }}" -r win-x64 --self-contained true /m:1

      # Build ShareX.exe for the matrix RID so packaging has the correct binaries
      - name: Build ShareX.exe target RID
        if: matrix.rid != 'win-x64'
        run: dotnet build "${{ env.APP_PROJ_PATH }}" --no-restore --configuration "${{ matrix.configuration }}" -r "${{ matrix.rid }}" --self-contained true /m:1

      # Build Setup as framework-dependent AnyCPU (no RID) so it runs on the x64 runner
      - name: Build Setup (no RID, framework-dependent)
        run: dotnet build "${{ env.SETUP_PROJ_PATH }}" --no-restore --configuration "${{ matrix.configuration }}" --self-contained false /m:1

      # Locate the Setup DLL without assuming TFM folder names
      - name: Find Setup DLL
        id: find_setup
        shell: pwsh
        run: |
          $cfg='${{ matrix.configuration }}'
          $dll = Get-ChildItem -Recurse -File -Path "ShareX.Setup\bin\$cfg" -Filter "ShareX.Setup.dll" | Select-Object -First 1
          if (!$dll) { Write-Error "ShareX.Setup.dll not found under ShareX.Setup\bin\$cfg"; exit 1 }
          echo "dll_path=$($dll.FullName)" >> $env:GITHUB_OUTPUT

      # Run Setup via dotnet and tell it which RID to package.
      # If ShareX.Setup ignores RID args, it will still succeed because both win-x64 and the target RID app outputs exist.
      - name: Run Setup packager
        shell: pwsh
        run: |
          $dll='${{ steps.find_setup.outputs.dll_path }}'
          $cfg='${{ matrix.configuration }}'
          $rid='${{ matrix.rid }}'
          $env:RUNTIME_IDENTIFIER = $rid   # optional hint if Setup reads it
          dotnet "$dll" -silent -job "$cfg"

      # Suffix outputs with RID if they exist
      - name: Suffix outputs with RID
        shell: pwsh
        run: |
          $v = "${{ env.APP_VERSION }}"
          $rid = "${{ matrix.rid }}"
          New-Item -ItemType Directory -Path "Output" -Force | Out-Null
          $files = @(
            "ShareX-$v-setup.exe",
            "ShareX-$v-portable.zip",
            "ShareX-$v-debug.zip",
            "ShareX-$v-Steam.zip",
            "ShareX-$v.appx",
            "ShareX-$v-debug.appx"
          )
          foreach ($f in $files) {
            $src = Join-Path "Output" $f
            if (Test-Path $src) {
              $name = [System.IO.Path]::GetFileNameWithoutExtension($src)
              $ext  = [System.IO.Path]::GetExtension($src)
              $dst  = Join-Path "Output" ($name + "-" + $rid + $ext)
              Move-Item -Force $src $dst
            }
          }

      - name: Upload artifact Setup
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: Setup-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-setup-${{ matrix.rid }}.exe

      - name: Upload artifact Portable
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: Portable-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-portable-${{ matrix.rid }}.zip

      - name: Upload artifact Debug
        if: matrix.configuration == 'Debug'
        uses: actions/upload-artifact@v4
        with:
          name: Debug-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-debug-${{ matrix.rid }}.zip

      - name: Upload artifact Steam
        if: matrix.configuration == 'Steam'
        uses: actions/upload-artifact@v4
        with:
          name: Steam-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-Steam-${{ matrix.rid }}.zip

      - name: Upload artifact MicrosoftStore
        if: matrix.configuration == 'MicrosoftStore'
        uses: actions/upload-artifact@v4
        with:
          name: MicrosoftStore-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-${{ matrix.rid }}.appx

      - name: Upload artifact MicrosoftStoreDebug
        if: matrix.configuration == 'MicrosoftStoreDebug'
        uses: actions/upload-artifact@v4
        with:
          name: MicrosoftStoreDebug-${{ matrix.rid }}
          path: Output/ShareX-${{ env.APP_VERSION }}-debug-${{ matrix.rid }}.appx
